{% extends 'base.html' %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Relatórios</h1>

<form method="get" action="/relatorios" class="mb-4 bg-white p-4 rounded shadow grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
  <div>
    <label class="block text-sm mb-1">Data Início</label>
    <input type="date" name="data_inicio" value="{{ dt_inicio.isoformat() }}" class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block text-sm mb-1">Data Fim</label>
    <input type="date" name="data_fim" value="{{ dt_fim.isoformat() }}" class="border rounded px-3 py-2 w-full" />
  </div>
  <div class="md:col-span-2 text-sm text-gray-600">
    Selecione um dia ou um período. Vendas canceladas são desconsideradas dos totais.
  </div>
  <div>
    <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 w-full">Aplicar</button>
  </div>
  
</form>

<!-- KPIs do período -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-600">Total do Período</div>
    <div class="text-2xl font-semibold text-green-600">R$ {{ '%.2f'|format(totais.geral) }}</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-600">Qtd. Vendas</div>
    <div class="text-2xl font-semibold">{{ totais.qtd }}</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-600">Média Diária</div>
    <div class="text-2xl font-semibold text-blue-600">R$ {{ '%.2f'|format(totais.media_diaria) }}</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-600">Ticket Médio</div>
    <div class="text-2xl font-semibold text-purple-600">R$ {{ '%.2f'|format(totais.ticket_medio) }}</div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Totais por Forma</h2>
    <div class="text-sm space-y-1">
      <div><strong>DINHEIRO:</strong> R$ {{ '%.2f'|format(totais.dinheiro) }}</div>
      <div><strong>PIX:</strong> R$ {{ '%.2f'|format(totais.pix) }}</div>
      <div><strong>DÉBITO:</strong> R$ {{ '%.2f'|format(totais.debito) }}</div>
      <div><strong>CRÉDITO:</strong> R$ {{ '%.2f'|format(totais.credito) }}</div>
    </div>
  </div>

  {% if caixa %}
  <div class="bg-white p-4 rounded shadow md:col-span-2">
    <h2 class="font-semibold mb-2">Caixa de {{ fmt_date(dt_inicio) }}</h2>
    <div class="text-sm text-gray-700 mb-3">Caixa único no período selecionado.</div>
    <a class="bg-gray-700 text-white px-3 py-2 rounded" href="/caixa/comprovante-fechamento/{{ caixa.id }}" target="_blank">Comprovante de Fechamento</a>
  </div>
  {% endif %}
</div>

<!-- Lista de vendas do período -->
<div class="bg-white p-4 rounded shadow">
  <h2 class="font-semibold mb-2">Vendas do Período</h2>
  {% if vendas %}
  <table class="w-full text-sm">
    <thead><tr><th class="text-left">Data/Hora</th><th class="text-left">Produto</th><th class="text-right">Valor</th><th>Pag.</th><th></th></tr></thead>
    <tbody>
      {% for v in vendas %}
      {% set is_cancelada = cancelados_ids and (v.id in cancelados_ids) %}
      <tr class="border-t {% if is_cancelada %}opacity-60{% endif %}">
        <td>{{ fmt_dt(v.created_at) }}</td>
        <td>
          {{ v.product_code }}
          {% if is_cancelada %}<span class="ml-2 text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">Cancelada</span>{% endif %}
        </td>
        <td class="text-right">R$ {{ '%.2f'|format(v.amount) }}</td>
        <td class="text-center">{{ payment_label(v.payment_method) }}</td>
        <td class="text-right">
          {% if not is_cancelada %}
            <a class="underline text-blue-700" href="/vendas/recibo/{{ v.id }}" target="_blank">Recibo</a>
          {% else %}
            <span class="text-xs text-gray-500">(recibo desabilitado)</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="text-sm text-gray-600">Nenhuma venda no período.</div>
  {% endif %}
</div>
{% endblock %}
