{% extends 'base.html' %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Lançar Venda</h1>
{% if error %}
<div class="p-2 mb-3 text-sm text-red-700 bg-red-100 rounded">{{ error }}</div>
{% endif %}
{% if not caixa %}
<div class="p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded">Não há caixa aberto hoje. <a href="/caixa/abrir" class="underline">Abrir caixa</a>.</div>
{% else %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div class="bg-white p-4 rounded shadow md:col-span-2">
  <form method="post" action="/vendas/nova" hx-post="/vendas/nova" hx-target="#totais" hx-swap="innerHTML" class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
      <div class="md:col-span-2">
        <label class="block text-sm mb-1">Código do Produto</label>
        <input name="product_code" class="w-full border rounded px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm mb-1">Valor (R$)</label>
        <input type="text" inputmode="decimal" name="amount" placeholder="0,00" autocomplete="off" class="w-full border rounded px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm mb-1">Forma de Pagamento</label>
        <select name="payment_method" class="w-full border rounded px-3 py-2">
          <option value="DINHEIRO">Dinheiro</option>
          <option value="PIX">PIX</option>
          <option value="DEBITO">Débito</option>
          <option value="CREDITO">Crédito</option>
        </select>
      </div>
      <div class="md:col-span-4 flex gap-2">
        <button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Lançar</button>
        <a href="/caixa/status" class="bg-gray-600 hover:bg-gray-700 text-white rounded px-4 py-2">Status</a>
      </div>
    </form>
  </div>
  <div id="totais" class="bg-white p-4 rounded shadow">
    {% include 'partials/totals.html' with context %}
  </div>
  <div id="vendas-dia" class="bg-white p-4 rounded shadow md:col-span-3">
    {% include 'partials/sales_list.html' with context %}
  </div>
</div>
<!-- Modal de confirmação de impressão -->
<div id="print-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white rounded shadow p-5 w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-2">Imprimir recibo?</h3>
    <p class="text-sm text-gray-600 mb-4">Deseja imprimir o recibo de pagamento desta venda?</p>
    <div class="flex justify-end gap-2">
      <button type="button" class="px-3 py-2 rounded border" onclick="window.hidePrintModal()">Não</button>
      <button type="button" id="print-modal-confirm" class="px-3 py-2 rounded bg-blue-600 text-white">Sim, imprimir</button>
    </div>
  </div>
</div>
<script>
  (function(){
    const modal = document.getElementById('print-modal');
    const confirmBtn = document.getElementById('print-modal-confirm');
    let currentUrl = null;
    window.showPrintModal = function(url){
      currentUrl = url;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    window.hidePrintModal = function(){
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentUrl = null;
    };
    confirmBtn.addEventListener('click', function(){
      if(currentUrl){
        try { const w = window.open(currentUrl, '_blank'); if(w && w.focus){ w.focus(); } } catch(e){}
      }
      window.hidePrintModal();
    });
  })();
</script>
{% endif %}
{% endblock %}